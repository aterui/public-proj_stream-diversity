---
title: "Ecosystem size and complexity dictate riverine biodiversity"
author:
- Akira Terui^[Department of Biology, University of North Carolina at Greensboro]
- Seoghyun Kim\footnotemark[1]
- Christine L. Dolph^[Department of Ecology, Evolution and Behavior, University of Minnesota]
- Taku Kadoya^[National Institute for Environmental Studies]
- Yusuke Miyazaki^[Shiraume Gakuen University]
output:
  word_document: default
  html_notebook: default
abstract:
  The species-area relationship (the SAR), a tendency in which species richness increases with increasing area, is one of the most robust empirical generalizations in ecology and formed the basis of area-based conservation strategies. However, many ecosystems possess a complex spatial structure that cannot be represented by area (the scale-invariant complexity), and its role in scaling biodiversity is largely unknown. Here, we hypothesized that ecosystem size and complexity jointly regulate biodiversity in rivers. Rivers are a prime example of fractal branching networks where the recurrent merging of diverse streams generates a pronounced self-similarity in complex branching patterns. Ecosystem complexity, which we defined as the probability of branching per unit river distance, should increase watershed-scale species richness by increasing habitat heterogeneity (habitat diversity per unit area). Meanwhile, ecosystem size should dictate metacommunity size and total habitat diversity (area x habitat heterogeneity), two primary factors that regulate watershed-scale species richness. We developed theoretical models simulating metacommunity dynamics in branching river networks and yielded results consistent with our hypothesis. Ecosystem size and complexity increased watershed-scale species richness ($\gamma$ diversity), and the importance of spatial turnover in species composition ($\beta$ diversity) was apparent when simulated species dispersal is limited. Cross-watershed comparisons across two biogeographic regions (Hokkaido, Japan and Midwest, US) provided empirical support for the theoretical predictions. In both regions, watershed-scale species richness increased with ecosystem size (watershed area) and complexity (branching probability) through enhanced spatial turnover in species composition over the branching network. There is now a clear need to consider the dimension of ecosystem complexity in biodiversity conservation. The dual dimensional approach - size and complexity - should broaden viable options for spatial planning of protected areas or restoration sites, thereby helping reconcile the conflicts between biodiversity conservation and societal demands.
  
bibliography: reference.bib
csl: nature.csl
---

```{r setup, include=FALSE}

pacman::p_load(tidyverse, sf)

## read gis files
filename <- list.files(path = here::here('/empirical/data_gis'), full.names = T)
wsd_subset <- lapply(filename[str_detect(filename, "wsd_subset")], st_read)
point_subset <- lapply(filename[str_detect(filename, "point_subset")], st_read)
shape <- lapply(filename[str_detect(filename, "shape")], st_read)
shape[[1]] <- st_set_crs(shape[[1]], st_crs(wsd_subset[[1]]))

## read theory file
dat_sim <- read_csv(here::here('/theory/result/result_sim2020-11-10.csv'))

n_scenario <- dat_sim %>% distinct(n_species,
                     mean_env_source,
                     sd_env_source,
                     rho,
                     asymmetry_factor,
                     min_optim,
                     max_optim,
                     sd_env_lon,
                     theta,
                     K0,
                     sd_env,
                     spatial_env_cor,
                     phi,
                     min_niche_width,
                     max_niche_width,
                     niche_cost,
                     p_dispersal,
                     min_alpha,
                     max_alpha) %>% 
  nrow()

source(here::here('/empirical/analysis_lm_bf.R'))

```

# Maintext

Ecologists have long sought to understand the general drivers of biodiversity. One of the most robust empirical generalizations in ecology is the positive relationship between species richness and area, i.e., the species-area relationship (the SAR)[@lomolinoEcologyMostGeneral2000a]. In 1921, Arrhenius[@arrheniusSpeciesArea1921] formulated the SAR as a power-law $S = cA^z$ ($S$ is the number of species observed in a given geographic area $A$, $c$ a constant, and $z$ a scaling exponent), an equation currently known as the Arrhenius species-area relationship. Since then, the spatial scaling of species richness has been observed in many taxonomic groups[@triantisIslandSpeciesArea2012]. The SAR is ubiquitous because multiple mechanisms produce an apparently similar pattern. Larger ecosystems typically support more diverse metacommunities due to increased habitat diversity[@kallimanisHowDoesHabitat2008a], larger metacommunity size[@ben-hurDisentanglingMechanismsUnderlying2020;@hubbellUnifiedNeutralTheory2001], and/or enhanced colonization dynamics[@lososTheoryIslandBiogeography2009]. Importantly, the SAR provides the foundation for global conservation efforts. For example, conservation ecologists have used the SAR estimates to design marine and terrestrial protected areas, which currently encompass more than 30 million km^2^ globally[@deguignet2014UnitedNations2014].

Many ecosystems, however, possess a complex spatial structure that cannot be represented by area - a dimension referred to as scale-invariant complexity[@rinaldoEvolutionSelectionRiver2014; @rodriguez-iturbeFractalRiverBasins2001]. Such complexity is evident in branching ecosystems, including rivers, trees, and mountain ranges, to name just a few[@rodriguez-iturbeFractalRiverBasins2001]. Geomorphic or biological processes generate a pronounced self-similarity in complex branching patterns such that the part and the whole look alike[@rodriguez-iturbeFractalRiverBasins2001]. Even though the branching structure is independent of spatial scale, it forms a physical template that dictates habitat diversity and dispersal corridors for living organisms[@grantLivingBranchesPopulation2007; @rinaldoRiverNetworksEcological2018;@tonkinRoleDispersalRiver2018]. Limited, but accumulating evidence suggests that classical metapopulation and metacommunity theories cannot predict ecological dynamics driven by branching structure[@faganConnectivityFragmentationExtinction2002; @grantUseMultipleDispersal2010; @teruiMetapopulationStabilityBranching2018], and this recognition has led to recent developments of spatial theories devoted to complex branching ecosystems[@altermattDiversityRiverineMetacommunities2013; @carraraComplexInteractionDendritic2014; @carraraDendriticConnectivityControls2012; @teruiMetapopulationStabilityBranching2018]. However, most research has explored the consequences of branching complexity for local community structure[@altermattRiverNetworkProperties2013; @brownDendriticNetworkStructure2010] or has relied solely on theoretical arguments with limited replications of branching architecture[@holtRoleBranchingMaintenance2018]. At present, we lack a comprehensive evaluation of how branching complexity, combined with ecosystem size, scales biodiversity at the metacommunity level. Filling this knowledge gap may provide common ground for achieving successful conservation in spatially complex ecosystems, where the accelerated species loss threatens the delivery of ecosystem services[@dudgeonFreshwaterBiodiversityImportance2006].

Here, we hypothesize that ecosystem size and complexity dictate biodiversity patterns in rivers, a prime example of complex branching ecosystems. The recurrent merging of diverse streams and rivers produces larger, ecologically distinct channels, ultimately forming a fluvial network with fractal branching patterns[@rodriguez-iturbeFractalRiverBasins2001]. As such, the complexity of branching structure, which we define here as the probability of branching per unit river distance [@teruiMetapopulationStabilityBranching2018; @yeakelSynchronisationStabilityRiver2014a], should control the habitat heterogeneity of the ecosystem (habitat diversity per unit area). Meanwhile, ecosystem size (watershed area) should determine the metacommunity size and total habitat diversity (area x heterogeneity). We predict that ecosystem size and branching complexity increase $\gamma$ diversity by enhancing either $\alpha$ and/or $\beta$ diversity under different ecological scenarios. The present study combines theory and empirical analysis of extensive community data from two different regions of the globe to provide crucial insights into how ecological communities are structured in complex branching networks.

First, we theoretically analyzed the influences of ecosystem size and branching complexity on $\gamma$ diversity. We depicted branching ecosystems as a spatial network of connected habitat patches (**Figure 1**) where two factors determine mean environmental conditions at each habitat patch: (1) headwater environments (the most upstream habitat patch) and (2) local environmental noise. Environmental values at headwaters are drawn randomly from a normal distribution and propagate downstream with local environmental noise (i.e., a spatial autoregressive process with white noise). These environmental values recurrently 'mix' at confluences considering the relative size of joining tributaries (see Methods). Therefore, our network-generation procedure resembles natural processes of how branching river networks create diverse habitats in a metacommunity. We then simulated metacommunity dynamics in the theoretical branching networks using a general metacommunity framework[@thompsonProcessbasedMetacommunityFramework2020]. In this model, 50 species with different abiotic niches (optimum and width) disperse along a network and compete for resources with varied strengths in temporally dynamic environments (see Methods for model details).

We considered `r n_scenario` simulation scenarios, which comprised a combination of four landscape and eight ecological scenarios. We distinguished landscape scenarios by setting four combinations of environmental variation at headwaters ($\sigma_h =$ `r unique(dat_sim$sd_env_source)`) and the degree of local environmental noise ($\sigma_l =$ `r unique(dat_sim$sd_env_lon)`). When $\sigma_h > \sigma_l$, branching produces greater habitat heterogeneity because headwaters are the primary source of environmental variation. In the meantime, when $\sigma_h \le \sigma_l$, local environmental noise masks environmental variation among tributaries, leading to minimal influences of branching on habitat heterogeneity. Thus, the inequality between $\sigma_h$ and $\sigma_l$ creates contrasting patterns of habitat heterogeneity. We also considered eight ecological scenarios that differ in dispersal distance, dispersal probability, and the maximum value of interspecific competition strength (Methods). Under each simulation scenario, we simulated 1000 time steps of metacommunity dynamics in `r max(dat_sim$n_rep)` branching networks with the gradients of ecosystem size (the number of habitat patches: `r min(dat_sim$n_patch)` to `r max(dat_sim$n_patch)`) and complexity (branching probability: `r round(min(dat_sim$p_branch), 2)` to `r round(max(dat_sim$p_branch), 2)`).

Our theoretical analysis yielded results consistent with our prediction. Ecosystem size and complexity both increased $\gamma$ diversity under a realistic landscape scenario (**Figures 2 and 3**), where the environmental variation at headwaters ($\sigma_h$) is greater than the degree of local environmental noise ($\sigma_l$) [@petersonModellingDendriticEcological2013; @teruiMetapopulationStabilityBranching2018]. The relationships had a characteristic of power-law (i.e., linear in a log-log scale) and were consistent under various ecological scenarios. The strength of competition and dispersal processes (dispersal distance and probability) did not change the relationships between $\gamma$ diversity and ecosystem properties (compare panels in **Figures 2 and 3**). Hence, the ecosystem size and complexity are expected to increase $\gamma$ diversity regardless of ecological scenarios.

However, dispersal processes affected mechanisms that underlie the positive effects of ecosystem size and complexity on $\gamma$ diversity (compare left and right columns in **Figures 2 and 3**). We observed a greater contribution of $\beta$ diversity (defined as $\frac{\gamma}{\alpha}$) to increased $\gamma$ diversity when dispersal limitation exists (i.e., species travel short distances). This pattern reflects significant spatial turnover of species composition over the branching network. In contrast, when the dispersal limitation was relaxed (species travel long distances), a clear increase in $\alpha$ diversity underpinned the positive relationships between $\gamma$ diversity and ecosystem properties. The results agree with previous predictions that increased dispersal homogenizes community composition while enhancing local diversity through increased immigrants from suitable habitat patches (i.e., mass effects)[@thompsonProcessbasedMetacommunityFramework2020]. These patterns were consistent across different levels of dispersal probabilities (**Figures S1 and S8**). The strength of competition decreased the maximum of $\alpha$ diversity but did not change the scaling relationships with ecosystem properties (**Figures 2 and 3**). In summary, our theory highlights how the apparently similar patterns in $\gamma$ diversity emerge through different ecological pathways.

Influences of ecosystem size and complexity differed significantly in their dependence on landscape scenarios. Ecosystem size had positive effects on $\gamma$ diversity regardless of landscape scenarios, although the slopes were steeper with greater environmental variation (higher $\sigma_h$ and/or $\sigma_l$) (**Figures 2 and S1-7**). This result is attributable to the fact that larger ecosystems can hold more individuals in a metacommunity[@hubbellUnifiedNeutralTheory2001]. In contrast, we observed limited or no influences of branching complexity when local environmental noise was equal to or exceeded environmental variation at headwaters ($\sigma_l \ge \sigma_h$). Under this scenario, branching may not contribute to the ecosystem's overall habitat diversity because local environmental noise masks environmental differences between branches (**Figures S9-14**). Therefore, this landscape scenario decouples the intimate relationship between branching structure and total habitat diversity, thereby eliminating the positive effect of branching complexity on $\gamma$ diversity. This theoretical prediction may not apply to pristine or semi-natural river networks where individual streams with diverse geological and/or climatic backgrounds show distinct environmental conditions, including water temperature, water chemistry, substrate, and flow/sediment regimes[@altermattDiversityRiverineMetacommunities2013; @bendaNetworkDynamicsHypothesis2004; @mooreEmergentStabilityLarge2015; @nakamuraDisturbanceRegimesStream2000; @petersonModellingDendriticEcological2013; @teruiMetapopulationStabilityBranching2018]. Instead, it may be more relevant to severely altered landscapes where human disturbance compromises the environmental distinctiveness of branches through, for example, flow regulations by dams[@poffHomogenizationRegionalRiver2007]. Hence, our theory has important implications for riverine biodiversity conservation by pointing to the crucial role of habitat diversity produced by branching structure.

The proposed theory provided important insights into how ecological communities are structured in branching networks; however, empirically testing the predictions is extremely difficult because it requires metacommunity-level replications. To confront this logistical challenge, we compiled fish community data that span across two geographic regions: the Hokkaido island in Japan and the Midwest in the United States. These regions are located in comparable ranges of latitude but support distinct fish communities. Therefore, this data set provides an excellent opportunity to examine the generality of our theoretical predictions. After careful data selection (see Methods and Supporting Information), we estimated $\alpha$, $\beta$, and $\gamma$ diversity (asymptotic species richness; Methods) at `r nrow(wsd_subset[[1]]) + nrow(wsd_subset[[2]])` watersheds (`r nrow(wsd_subset[[1]])` in Hokkaido and `r nrow(wsd_subset[[2]])` in Midwest), each of which comprised $\ge$ 10 sites of presence-absence fish community data (a total of `r nrow(point_subset[[1]]) + nrow(point_subset[[2]])` sites). We considered watersheds as independent replicates of metacommunities if the river network flows into one of the following: the ocean, a large lake ($\ge$ 10 km² in the areal area), or a large river that may represent lentic habitats ($\ge$ 5000 km² in the watershed area). We combined this data set with geospatial information (watershed area, branching probability, annual mean temperature, annual cumulative precipitation, and % forest) to examine potential influences of macro-scale drivers of species diversity. Using this data set, we developed global and region-specific models for each of the diversity measures ($\alpha$, $\beta$, and $\gamma$ diversity) to examine whether observed patterns are consistent across the two geographic regions. In the global model, we assumed that effects of ecosystem size (watershed area) and complexity (branching probability) are constant across the two regions (i.e., fixed slopes). Meanwhile, the region-specific model assumes region-specific slopes of ecosystem size and complexity by including interaction terms with the dummy binary variable of the region (Hokkaido = 0; Midwest = 1). We compared the performance of these competing models using the Bayes factor, a measure of the strength of evidence in favor of one model over the alternative.

Despite the substantial difference in fish fauna between the study regions, the estimated Bayes factor in favor of the global model was `r round(fit$gamma$bayes_factor, 1)` for $\gamma$ diversity; this result strongly supports the consistent effects of ecosystem size and complexity on $\gamma$ diversity across the two biogeographic regions. We found patterns consistent with our theoretical predictions (**Table 1 and Figure 4**). The estimated $\gamma$ diversity increased with increasing watershed area (ecosystem size) and branching probability (ecosystem complexity) across watersheds. These effects remained significant even after controlling for the potential influences of other environmental factors (precipitation, temperature, and land use) (**Table 1**). Overall, our statistical analysis provides strong empirical evidence that ecosystem size and complexity jointly scale riverine biodiversity at the metacommunity level.

Similarly, we found weak to moderate supports for the global models of $\alpha$ and $\beta$ diversity (Bayes factor: `r round(fit$alpha$bayes_factor, 1)` and `r round(fit$beta$bayes_factor, 1)`, respectively). In both regions, $\beta$ diversity responded significantly to ecosystem size and complexity while $\alpha$ diversity showing a vague response to these ecosystem properties (**Table 1 and Figure 4**). In our simulations, this pattern has emerged under the scenarios with dispersal limitation, which elegantly matches the previous observations of stream fish movement. Direct (mark-recapture) and indirect observations (e.g., genotyping) recurrently revealed the restricted movement of stream fish, typically limited to several tens to hundreds of meters in distance[@comteFishDispersalFlowing2018; @radingerPatternsPredictorsFish2014; @rodriguezRestrictedMovementStream2002]. The reciprocal agreement of theoretical and empirical patterns provides indirect but convincing evidence that dispersal limitation plays a key role in driving the associations between $\gamma$ diversity and ecosystem properties in rivers.

The consistent effect of branching probability on $\gamma$ diversity across the study regions is noteworthy because the watersheds in the Midwest are severely altered by agriculture (median % agricultural land use: `r round(median(wsd_subset[[2]]$frac_agri)*100)`% for Midwest and `r round(median(wsd_subset[[1]]$frac_agri)*100)`% for Hokkaido). If the intensive land use by humans causes significant homogenization of in-stream habitat conditions among tributaries, theory predicts weakened effects of branching probability on $\gamma$ diversity. However, $\gamma$ diversity increased significantly with increasing branching probability in this highly modified landscape, suggesting that tributaries still sustain unique environmental conditions to support high spatial turnover of species composition. In support of this interpretation, $\beta$ diversity increased with increasing branching probability in both regions (**Figure 4**). It is conceivable that local geological and geomorphological differences, such as slope, aspect, and soil porosity, persist in human-dominated landscapes to maintain the diversity of in-stream processes among tributaties[@bendaNetworkDynamicsHypothesis2004]. Although our analysis is correlative and cannot provide conclusive evidence, the finding is encouraging because the branching complexity of river networks may serve as a natural defense system to human-induced environmental changes.

There may be confounding factors that are not incorporated into our statistical models. However, we are confident in our statistical inference because the observed patterns were fairly consistent with our theoretical predictions that are free from any confounding effects. Further, our fitted models generally showed high R^2^ values ($\alpha$ diversity: `r round(summary(fit$alpha$model)$r.squared, 2)`; $\beta$ diversity, `r round(summary(fit$beta$model)$r.squared, 2)`; $\gamma$ diversity `r round(summary(fit$gamma$model)$r.squared, 2)`) with no signs of spatial autocorrelation in residuals. Therefore, it is very unlikely that spurious correlations are responsible for our results.

The emerging complexity-diversity relationship points to several important avenues for riverine biodiversity conservation. First and foremost, there is now a clear need to explicitly consider the dimension of ecosystem complexity to achieve successful conservation. Human-induced habitat alterations, including flow regulation[@poffHomogenizationRegionalRiver2007], habitat fragmentation[@fukushimaModellingEffectsDams2007; @moritaEffectsHabitatFragmentation2002], and stream burial, may compromise or restrict access to the diverse habitats that complex branching networks may support. Hence, it is imperative to recognize the role of branching complexity and minimize the homogenizing effects of human activities. Second, the complexity perspective may provide insights into the spatial planning of conservation efforts. Riverine reserves and local restoration are increasingly recognized as an effective management tool, and how to design a spatial network of conservation sites in rivers is an area of active research[@koningNetworkGrassrootsReserves2020; @stollSmallImpoverishedRegional2013; @sundermannRiverRestorationSuccess2011]. While large reserves or restoration sites are undoubtedly important[@koningNetworkGrassrootsReserves2020], our results indicate the potential of coordinated networks of local conservation sites in protecting biodiversity. For example, synergies of multiple small reserves may emerge at the watershed scale when ecologically-distinct tributaries are involved in the design, as evidenced by the recent successful conservation of tropical fishes in Thailand's Salween basin[@koningNetworkGrassrootsReserves2020]. Our findings, therefore, offer the ecological foundation for the network-based conservation strategies in rivers, broadening viable options towards successful conservation.

While the prevailing evidence supports the importance of ecosystem size in scaling species diversity, ecosystem complexity - especially branching structure - has not received the attention it deserves. Ecosystems are inherently complex in their spatial structure, providing a physical template that creates a wide spectrum of niche opportunities for living organisms. Hence, our findings should be broadly applicable to many taxa and ecosystems. The generalization of our findings in spatially complex ecosystems represents a frontier for future research.


# Methods

## Theory

### Network generation

We depicted branching ecosystems as a spatial network of connected habitat patches. Habitat patches can be either non-branching or branching river sections with a unit length $l$, which defines the scale of local species interactions. Two parameters determine the geometric properties of simulated branching networks: the number of habitat patches $N_p$ (ecosystem size) and branching probability $P_b$ (ecosystem complexity). Each habitat patch is assigned to be a branching patch (including upstream terminals) with probability $P_b$ or a non-branching patch with probability $1-P_b$. In this framework, an individual branch is a consecutive series of non-branching patches terminated at a branching patch; therefore, the number of habitat patches in a single branch $n_b$ is a realization of a random variable drawn from a geometric distribution $n_{b} \sim Ge(P_{b})$. This representation has two merits. First, it reflects observed patterns of branch length distribution, which is known to follow an exponential distribution (a continuous version of a geometric distribution). Second, it preserves the fractal nature of branching patterns[@peckhamReformulationHortonLaws1999].

Two sources of variation characterize the long-term average of abiotic environment $\mu_z$ at each habitat patch: environmental variation at headwaters ($\sigma_h$) and local environmental noise ($\sigma_l$). We draw random values from a normal distribution with a mean of zero and SD of $\sigma_{h}$ and assigned them to headwater patches (i.e., the most upstream patches). These environmental values at headwaters propagate downstream through a spatial autoregressive process defined as:

$$
\mu_{z,k} = \rho \mu_{z,k+1} + \epsilon_{k}
$$

where $\mu_{z,k}$ is the environmental value at longitudinal position $k$ ($k$ is the network distance from the outlet patch; $k = 1$ at the outlet), $\rho$ is the strength of spatial autocorrelation and $\epsilon_k$ is the local environmental noise that follows a normal distribution with a mean of zero and SD of $\sigma_l$. The parameter $\rho$ can take values of $0-1$ with larger values indicating greater spatial autocorrelation. In this study, we set $\rho = 1$ to mimic strong spatial autocorrelation in riverine environments. At confluences, we took a weighted mean of environmental values given the relative size of upstream contributing area of joining tributaries:

$$
\begin{align}
\mu_{z,k} &= \omega(\rho \mu_{z,k+1}^R + \epsilon_{k}^R) + (1-\omega)(\rho \mu_{z,k+1}^L + \epsilon_{k}^L) \\
\omega &= \frac{A_{k+1}^R}{A_{k+1}^R + A_{k+1}^L}
\end{align}
$$
where $R$ and $L$ denote "right" and "left" branches, respectively, and $A_k$ is the number of upstream habitat patches at longitudinal position $k$ (akin to the upstream watershed area). With this expression, larger tributaries have a greater influence on the downstream environment, as observed in natural river networks[@bendaNetworkDynamicsHypothesis2004].

### Metacommunity model
We simulated metacommunity dynamics in branching river networks following the metacommunity framework proposed by Thompson et al.[@thompsonProcessbasedMetacommunityFramework2020]. In this framework, abiotic environmental conditions (density-independent), intra- and interspecific competition (density-dependent), and dispersal regulate a species' realized population growth. Below, we describe the details of our metacommunity model.

The realized number of individuals $N_{ix}(t + 1)$ (species $i$ at patch $x$ and time $t+1$) is given as:

$$
N_{ix}(t + 1) \sim Poisson(n_{ix}(t) + I_{ix}(t) - E_{ix}(t))
$$
where $n_{ix}(t)$ is the expected number of individuals given the local community dynamics at time $t$, $I_{ix}(t)$ the expected number of immigrants to patch $x$, and $E_{ix}(t)$ the expected number of emigrants from patch $x$. The realized discrete number of individuals is drawn from a Poisson distribution to account for stochasticity in demographic and dispersal processes[@fronhoferClassicalMetapopulationDynamics2017; @thompsonProcessbasedMetacommunityFramework2020]. Local community dynamics are simulated based on the Beverton-Holt equation:

$$
n_{ix}(t) = \frac{N_{ix}(t)r_{ix}(t)}{1 + \frac{r_{0,i}-1}{K_{x}}\sum_{j=1}^S{\alpha_{ij}N_{jx}(t)}}
$$

where $r_{ix}(t)$ is the reproductive rate of species $i$ given the environmental condition at patch $x$ and time $t$, $r_{0,i}$ the maximum reproductive rate of species $i$, $K_{x}$ the carrying capacity at patch $x$, $\alpha_{ij}$ the competition coefficient between species $i$ and $j$, and $S$ the number of species in a metacommunity. $K_x$ was expressed as a function of the number of upstream contributing patches $A_x$ ($K_x = 100A_x$) to represent increasing habitat size with increasing upstream watershed area[@altermattRiverNetworkProperties2013; @teruiThreeEcologicalFactors2016]. The parameter $\alpha_{ij}$ is expressed as the strength of interspecific competition relative to that of intraspecific competition such that interspecific competition is greater than intraspecific competition if $\alpha_{ij}$ > 1 (intraspecific competition coefficient was set constant as $\alpha_{ii} = 1$). $\alpha_{ij}$ was drawn randomly from a uniform distribution as $\alpha_{ij} \sim Unif(0, \alpha_{max})$. The density-independent reproductive rate $r_{ix}(t)$ is affected by abiotic environments (non-consumable) and determined by the following Gaussian function:

$$
r_{ix}(t) = cr_{0,i}~exp[{-\frac{(\mu_i-z_x(t))^2}{2\sigma^2_{niche,i}}}]
$$
where $\mu_i$ is the optimal environmental value for species $i$, $z_x(t)$ the environmental value at patch $x$ and time $t$, and $\sigma_{niche,i}$ the niche width of species $i$. Species with a wider niche (greater values of $\sigma_{niche}$) should always have a greater competitive ability in the absence of the cost of a wide niche. Therefore, we introduced the cost of a wide niche by multiplying $c$[@chaianunpornEvolutionaryResponsesClimate2015]:

$$
c = exp(-\frac{\sigma_{niche,i}^2}{2\nu^2})
$$ 

Smaller values of $\nu$ imply greater costs of having a wider niche (i.e., decreased maximum reproductive rate) and reduce the realized reproductive rate $r_{ix}(t)$ near the niche optimum.

The environmental value at patch $x$ and time $t$, $z_x(t)$, is assumed to follow a multivariate normal distribution as $z_{x}(t) \sim MVN(\mu_z, \Omega_z)$. $\mu_z$ is the vector of mean environmental conditions of patches, and $\Omega_z$ is the variance-covariance matrix. Spatial autocorrelation in temporal environmental dynamics is considered by expressing the off-diagonal elements as:

$$
\Omega_{xy} = \sigma_z^2~exp(-\phi d_{xy})
$$

$\Omega_{xy}$ denotes the temporal covariance of environmental conditions between patch $x$ and $y$, which is assumed to decay exponentially with increasing distance between the patches $d_{xy}$. The parameter $\phi$ determines the degree of the distance decay of environmental correlates.

The expected number of emigrants at time $t$ is the product of dispersal probability $p_d$ and $n_{ix}(t)$: $E_{ix}(t) = p_{d}n_{ix}(t)$. The immigration probability at patch $x$ for species $i$, $\xi_{ix}(t)$, is calculated using the following equation that accounts for separation distance among habitat patches and dispersal capability of a species:

$$
\xi_{ix}(t) = \frac{\sum_{y,y \neq x}E_{iy}(t)~exp(-\theta d_{xy})}{\sum_{x} \sum_{y,y \neq x}E_{iy}(t)~exp(-\theta d_{xy})}
$$
where $d_{xy}$ is the separation distance between patch $x$ and $y$. The parameter $\theta$ regulates the dispersal distance of a species that follows an exponential distribution ($\theta^{-1}$ corresponds to the expected dispersal distance). The expected number of immigrants is calculated as $I_{ix}(t) = \xi_{ix}(t)\sum_x^{N_p} E_{ix}$.

### Simulation
We set four landscape and eight ecological scenarios, resulting in a total of `r n_scenario` sets of parameter combinations. For landscape scenarios, we changed values of environmental variation at headwaters ($\sigma_h$) and the degree of local environmental noise ($\sigma_l$) separately to create contrasting patterns of habitat heterogeneity. Specifically, we used two values (0.01 and 1) for each of SD parameters. When $\sigma_h > \sigma_l$, branching exhibits important effects on habitat heterogeneity in the ecosystem because headwaters are the primary source of environmental variation. When $\sigma_h \le \sigma_l$, local environmental noise masks environmental variation among tributaries, leading to minimal influences of branching on habitat heterogeneity in the ecosystem.

For ecological scenarios, we varied three ecological parameters that are relevant for dispersal and interspecific competition: dispersal distance ($\theta =$ `r unique(dat_sim$theta)`), dispersal probability ($p_d =$ `r unique(dat_sim$p_dispersal)`), and the maximum value of competition coefficients ($\alpha_{max} =$ `r unique(dat_sim$max_alpha)`). This setup results in eight ecological scenarios with different levels of dispersal and competition.

We allowed interspecific variation in niche optimum and width, which were drawn from uniform distributions as $\mu_i \sim Unif(-1, 1)$ and $\sigma_{niche,i} \sim Unif(0.1, 1)$. We used fixed values for the following parameters: maximum reproductive number ($r_{0,i} =$ 4), niche cost ($\nu =$ `r unique(dat_sim$niche_cost)`), the degree of temporal fluctuation in abiotic environments ($\sigma_z =$ `r unique(dat_sim$sd_env)`), and the degree of spatial autocorrelation in temporal environmental dynamics ($\phi =$ `r unique(dat_sim$phi)`).


## Empirical data analysis

### Fish community data

We compiled fish data at two biogeographic regions: Hokkaido island, Japan and Midwest, US. For Hokkaido, we used data from the Hokkaido Freshwater Fish Database HFish, monitoring data at protected watersheds, and primary data collected from literature, which collectively cover the entire Hokkaido island. For the Midwest, we assembled fish community data collected by Iowa Department of Natural Resources, Illinois Environmental Protection Agency and Illinois Department of Natural Resources, Minnesota Pollution Control Agency, and Wisconsin Department of Natural Resources. We detailed procedures for initial data selection in Supporting Information.

We considered watersheds as independent replicates of metacommunities if the river network flows into one of the following: the ocean, a large lake ($\ge$ 10 km² in the areal area) or a large river that may represent lentic habitats ($\ge$ 5000 km² in the watershed area). Metacommunities with $\ge$ 10 sampling sites were used in our analysis because a small sample size inflates statistical uncertainties in estimating diversity metrics (Supporting Information).

We estimated $\alpha$, $\beta$, and $\gamma$ diversity at each watershed. $\gamma$ diversity is the total species richness at each watershed. Since it is impossible to sample all species present in each watershed, we used asymptotic species richness as a proxy for $\gamma$ diversity. Asymptotic species richness can be interpreted as the estimated true species richness in a given area when estimated using spatial replicates of local community data within a metacommunity[@chaoRarefactionExtrapolationHill2014a; @chaseEcosystemDecayExacerbates2020]. We estimated asymptotic species richness using sampling sites located in the same watershed (i.e., spatial replicates within a metacommunity) via the R package iNEXT[@hsiehINEXTPackageRarefaction2016]. We assessed the completeness of the observed species richness based on sample coverage, which is the proportion of observed species richness to asymptotic species richness. We excluded watersheds whose sample coverage was below 0.9 because the estimates of asymptotic species richness may contain non-negligible statistical uncertainty. $\alpha$ diversity was estimated by taking an average of local species richness at each site. $\beta$ diversity was estimated by dividing the estimated $\gamma$ diversity by $\alpha$ diversity.

After the data selection procedure, we obtained diversity estimates from `r nrow(wsd_subset[[1]]) + nrow(wsd_subset[[2]])` watersheds (Hokkaido: `r nrow(wsd_subset[[1]])`, Midwest: `r nrow(wsd_subset[[2]])`), which encompassed a total of `r nrow(point_subset[[1]]) + nrow(point_subset[[2]])` sites (Hokkaido: `r nrow(point_subset[[1]])`, Midwest: `r nrow(point_subset[[2]])`). We used this data set for statistical analysis. Fish species observed in our data were listed in **Tables S1 and S2**.

### Environmental data

We collected data for watershed characteristics (watershed area and branching probability), climatic variables (annual mean air temperature and cumulative precipitation), and land use (% forest). We delineated watershed polygons and river lines (defined as $\ge$ 1 km^2^) using Hydrologically Adjusted Elevations of MERIT Hydro[@yamazakiMERITHydroHighResolution2019] with ArcMap 10.7 and SAGA 6.3.0 combined with the R package 'RSAGA'[@brenningRSAGASAGAGeoprocessing2018]. Watershed area was estimated based on the delineated watershed polygons using functions in the R package 'sf'[@pebesmaSimpleFeaturesStandardized2018]. Branching probability was estimated by fitting exponential distributions to histograms of branch length (unit: kilometer, river segment between successive confluences or a confluence and the outlet/upstream terminal) as $branch~length \sim Exp(\lambda)$. A derived statistical quantity $1 − e^{−\lambda}$ corresponds to the theoretical branching probability $P_b$. We estimated the spatial averages of air temperature and cumulative precipitation at a 1-km resolution for each watershed, which were extracted from WorldClim 1.4[@hijmansVeryHighResolution2005] via the R package 'raster.' We calculated % forest for each watershed using land-use data in 2015 from Copernicus Global Land Service (100-m resolution)[@marcelbuchhornCopernicusGlobalLand2020]. 

### Statistical analysis

We developed linear models to examine the effects of macro-scale drivers on diversity metrics. Log-transformed diversity metrics ($\alpha$, $\beta$ and $\gamma$ diversity) at watershed $i$, $log_{10}~y_i$, are assumed to follow a normal distribution as $log_{10}~y_i \sim Normal(\mu_i, \sigma^2)$. The parameter $\mu_i$ was related to linear predictors, including log-transformed watershed area (ecosystem size; $log_{10}~WA$), log-branching probability (ecosystem complexity; $log_{10}~P_b$), region (coded as Hokkaido = 0, Midwest = 1; $region$), air temperature, precipitation, and percent of forest land use (logit-transformed). Although our primary focus of this analysis is to assess the effects of watershed area and branching probability, we included climate and land-use variables to control these effects statistically.

Climate and land use differed clearly between the regions. Therefore, we used residuals of the simple linear regressions between the climate or land-use variable (response variable) and region (explanatory variable) to avoid correlation between explanatory variables. The residuals represent deviations from the regional averages; positive values indicate values greater than the regional average while negative values indicating values smaller than the regional average.

We constructed two models for each of the diversity metrics: global and region-specific models. The global model assumes that the effects of watershed area and branching probability are consistent across biogeographic regions (i.e., no interactive effects of region with other linear predictors).

$$
\mu_i = \xi_0 + \xi_1~log_{10}~WA_i + \xi_2~log_{10}~P_{b,i} + \xi_3~region_i + \sum_k \xi_k x_{k,i}
$$
where $\xi_k$ is the intercept and regression coefficients for linear predictors. Meanwhile, the region-specific model assumes the effects of watershed area and branching probability differ between regions (i.e., interactions between region and watershed area/branching probability).

$$
\mu_i = \xi_0 + \xi_1~log_{10}~WA_i + \xi_2~log_{10}~P_{b,i} + \xi_3~region_i + \xi_4~log_{10}~WA_i \cdot region_i + \xi_5~log_{10}~P_{b,i} \cdot region_i + \sum_k \xi_k x_{k,i}
$$
We compared the performance of these competing models using the Bayes factor[@wagenmakersPracticalSolutionPervasive2007], which gives the relative strength of evidence in favor of the global model (M0) over the region-specific model (M1). We used Bayesian Information Criteria (BIC) of the linear models to approximate the Bayes factor[@wagenmakersPracticalSolutionPervasive2007]:

$$
Bayes~factor = exp(\Delta BIC_{10}/2)
$$
where $\Delta BIC_{10} = BIC(M1) - BIC(M0)$.

# Acknowledgements

# Author contributions

# References