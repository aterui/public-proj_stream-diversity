---
title: "MidWest Data Management"
author: "Seoghyun Kim"
date: "2/5/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r # WD and Package}
#Read Data
setwd("D:\\UNCG works\\MidWestData\\UM_TN_BiomonData\\For analysis\\Data management")
getwd()

# install package
library(reshape2);library(plyr);library(arm);library(ggplot2);library(scales);library(knitr);library(tidyr);library(bbmle);library(chron);library(grid);library(fmsb);library(foreign)

require(dplyr)

```



# 1. MN Data Management

## (1) Data Property
Three datasets were used to manage data. Each dataset has different property, thus we need to use and filter them out. Particularly, 'Visit_originalfile.csv' has date, 'Station_originalfile.csv' has GPS cordinates, and 'FishData_originalfile.csv' has fish data.
Data property:
(1) Station_originalfile.csv: FieldNum (site ID), GPS coodinates
(2) Visit_originalfile.csv: FieldNum (site ID), VisitNum (Unique sampling ID), Date
(3) FishData_originalfile.csv: FieldNum (site ID), VisitNum (Unique sampling ID), Fish list
Therefore, mating each file based on FieldNum (site ID) and VisitNum (Unique sampling ID) is the key process for the data management, and missing data should be removed.
```{r MN data}
## Read Data ##
# Visit data - this file has sampling date
MN.Visit <- read.csv("data/org-data_mn_visit.csv", header=TRUE, strip.white=TRUE)

# Station data - this file has GPS data
MN.Station <- read.csv("data/org-data_mn_station.csv", header=TRUE, strip.white=TRUE)

# Fish sampling data - this file has fish sampling data
MN.FishData <- read.csv("data/org-data_mn_fish.csv", header=TRUE, strip.white=TRUE)
MN.FishData$CommonName <- gsub(" ", "_", MN.FishData$CommonName) # replace space to underscore (under bar)
MN.FishData$CommonName <- toupper(MN.FishData$CommonName) # change common name format
```


## (2) Fish data treatment
This is to remove all unidentified species and hybrids that appeared in data. 
```{r MN Fish data treatment}
# Remove unidentified species and hybrid
MN.FishData <-MN.FishData[!(MN.FishData$CommonName %in% c("AMEIURUS_SPP.","CAMPOSTOMA_SPP.","CARPIODES_SPP.","CATOSTOMIDAE_-_UNIDENTIFIED","COMMON_SHINER_X_CREEK_CHUB","COMMON_SHINER_X_EMERALD_SHINER","COMMON_SHINER_X_HORNYHEAD
","COMMON_SHINER_X_SOUTHERN_REDBELLY_DACE","COMMON_SHINER_X_STONEROLLER","COMMON_SHINER_X_UNKNOWN","COMMON_SHINER_X_HORNYHEAD","COTTUS_SPP.","CREEK_CHUB_X_HORNYHEAD_CHUB","CREEK_CHUB_X_UNKNOWN","CYPRINELLA_SPP.","CYPRINIDAE_-_UNIDENTIFIED","FAM:_LAMPREY","FAM:_MINNOWS","GEN:_BUFFALOS","GEN:_CARPSUCKERS","GEN:_CATOSTOMUS","GEN:_COMMON_SUNFISHES","GEN:_ETHEOSTOMA","GEN:_NOTROPIS","GEN:_PERCINA","GEN:_PHOXINUS","GEN:_REDHORSES","GEN:_STONEROLLERS","GREEN_SUNFISH_X_BLUEGILL","GREEN_SUNFISH_X_BLUEGILL_X_PUMPKINSEED","GREEN_SUNFISH_X_ORANGESPOTTED_SUNFISH","GREEN_SUNFISH_X_PUMPKINSEED","HIODON_SPP.","HYBOGNATHUS_SPP.","HYBRID:_COMMON_SHINER_X_SO._REDBELLY_DACE","HYBRID:_GREEN_SUNF._X_BLUEGILL","HYBRID_MINNOW","HYBRID_PHOXINUS","HYBRID_SUNFISH","ICTIOBUS_SPP.","LAMPREY_AMMOCOETE","LAMPREYS_(AMMOCOETE)","LAMPREYS","LEPISOSTEUS_SPP.","MOXOSTOMA_SPP.","NO_FISH_CAPTURED","NOTROPIS_SPP.","PERCINA_SPP.","POMOXIS_SPP.","PUMPKINSEED_X_BLUEGILL","PUMPKINSEED_X_WARMOUTH","ROSYFACE/CARMINE_SHINER","RUSTY_CRAYFISH","STICKLEBACKS_UNSP.","SUBFAM:_BUFFALO/CARPSUCKERS","TIGER_TROUT","TIGER_TROUT_(I21_X_I22)", "STONEROLLERS","PEARL_DACE", "QUILLBACK_CARPSUCKER", "GOLDFISH")),]

# Change name
MN.FishData[MN.FishData=="AMERICAN_BROOK_LAMPREY_(AMMOCOETE)"]<- "AMERICAN_BROOK_LAMPREY"
MN.FishData[MN.FishData=="CHESNUT_LAMPREY_(AMMOCOETE)"]<- "CHESTNUT_LAMPREY"
MN.FishData[MN.FishData=="NORTHERN_BROOK_LAMPREY_(AMMOCOETE)"]<- "NORTHERN_BROOK_LAMPREY"
MN.FishData[MN.FishData=="SILVER_LAMPREY_(AMMOCOETE)"]<- "SILVER_LAMPREY"
MN.FishData[MN.FishData=="SOUTHERN_BROOK_LAMPREY_(AMMOCOETE)"]<- "SOUTHERN_BROOK_LAMPREY"
MN.FishData[MN.FishData=="NORTHERN_HOG_SUCKER"]<- "NORTHERN_HOGSUCKER"
MN.FishData[MN.FishData=="TROUT-PERCH"]<- "TROUT_PERCH"
MN.FishData[MN.FishData=="TROUTPERCH"]<- "TROUT_PERCH"
```


## (3) Manage and prepare masterfile
Following script is to check/assess data property and prepare masterfile of MN data.
```{r class.source="bg-success", class.output="bg-warning"}
# MN Data management #
## (1) Extract fish sampling site number - unique sampling (VisitNum) and site number (FieldNum)
MN.Fish.site <- MN.FishData %>%
                select(VisitNum, FieldNum) 

 # Check the unique number of stations based on FieldNum
MN.Fish.site01 <- MN.Fish.site[!duplicated(MN.Fish.site[c('FieldNum')]),]
str(MN.Fish.site01) # n=2545
MN.Fish.site02 <- MN.Fish.site[!duplicated(MN.Fish.site[c('VisitNum')]),]
str(MN.Fish.site02) # n= 3405 - there is a mismatch

 # Mark stations where actually caught fish 
MN.Fish.site02$FishSample <- '1' # Add one column to mark actual fish sampling
MN.Fish.site02$FieldNum <- NULL # Remove FieldNum



## (2) Extract fish sampling station from "MN.Visit" file

 # Attach Fish.site02 to MN.Visit 
MN.Visit02 <- left_join(MN.Visit, MN.Fish.site02, by = "VisitNum")
MN.Visit02$FishSample[is.na(MN.Visit02$FishSample)] <- 0 # fill NA to 0 

 # Remove sites without fish sampling data
MN.Visit03 <- MN.Visit02[which(MN.Visit02$FishSample=='1'), ] 
str(MN.Visit03) # n=3049

 # How about unique number of sampling stations?
MN.Visit031 <- MN.Visit03[!duplicated(MN.Visit03[c('FieldNum')]),] 
str(MN.Visit031) # n=2372

 # Attach MN.Station to MN.Visit03 
MN.Visit04 <- left_join(MN.Visit03, MN.Station, by = "FieldNum")

 # Check multiple sampling occasions in each station (duplicate)
MN.Site.Duplicate <-aggregate(VisitNum ~ FieldNum, data = MN.Visit04, "NROW")
summary(MN.Site.Duplicate) # 530 sites were visited more than one time. Range: 2 - 7, median= 1


## (3) Prepare Masterfile

 # Extract columns from station data
MN.Visit06 <- MN.Visit04 %>%
              select(State, FieldNum, VisitNum, VisitDate, LAT8xDD, LON8xDD, StationLength) # select column

 # Extract columns from fish sampling data
MN.FishData02 <- MN.FishData %>%
                 select(VisitNum, Name1, Name2, CommonName, Number) %>% # select column
                 rename(GenusName= Name1, Speciesname= Name2) # change column name

 # Attach fish data to station data
MN.Masterfile01 <- left_join(MN.FishData02, MN.Visit06, by = "VisitNum")  
str(MN.Masterfile01) # This data still has Sampling occasion without collected fish

 # Remove station which has no fish sampling data
MN.Visit07 <- MN.Visit04 %>%
              select(VisitNum, FishSample) 

MN.Masterfile02 <- left_join(MN.Visit07, MN.Masterfile01, by = "VisitNum")  
MN.Masterfile02 <- MN.Masterfile02[which(MN.Masterfile02$FishSample=='1'), ] # select stations which collected fish
MN.Masterfile02$FishSample <- NULL # Remove 'FishSample' column

 # Check duplicate
MN.Masterfile02.check1 <- MN.Masterfile02[!duplicated(MN.Masterfile02[c('FieldNum')]),] 
str(MN.Masterfile02.check1) # n=2372 correct
MN.Masterfile02.check2 <- MN.Masterfile02[!duplicated(MN.Masterfile02[c('VisitNum')]),] 
str(MN.Masterfile02.check2) # n= 3049 correct

 # Re-order column
MN.Masterfile02 <-MN.Masterfile02[c("State", "FieldNum", "VisitNum", "VisitDate", "LAT8xDD", "LON8xDD", "GenusName", "Speciesname", "CommonName",  "Number")]

 # Change column name
names(MN.Masterfile02) <- c("State", "SiteID", "VisitUniqueID", "Date", "LAT", "LON", "GenusName", "SpeciesName", "CommonName", "Abundance")

 # Several treatments
MN.Masterfile02$GenusName <- NULL # Remove genus name
MN.Masterfile02$SpeciesName <- NULL # Remove species name
MN.Masterfile.fishdata <- MN.Masterfile02 # Rename
MN.Masterfile.fishdata$VisitUniqueID <-as.character(MN.Masterfile.fishdata$VisitUniqueID) # make as character
MN.Masterfile.fishdata$SiteID <-as.character(MN.Masterfile.fishdata$SiteID) # make as character
MN.Masterfile.fishdata$Abundance <-as.numeric(MN.Masterfile.fishdata$Abundance) # make as numeric value



## (4) Masterfile including all sampling occasions (combination of site and date)

str(MN.Masterfile.fishdata)



## (5) Select the latest sampling occasion in each station

 # Split Date into month, day, year
MN.Masterfile.fishdata$Date <- as.Date(MN.Masterfile.fishdata$Date, "%m/%d/%Y")

 # Filter SiteID then select the latest Occasion
MN.Masterfile.sort <- aggregate(Date ~ SiteID, data= MN.Masterfile.fishdata, "max") # select latest sampling occasion based on sampling date
MN.Masterfile.sort$Latest <-'1' # Add Column to mark this site
MN.Masterfile.sort2 <- left_join(MN.Masterfile.fishdata, MN.Masterfile.sort, by = c("SiteID", "Date")) # Merge two data frames based on SiteID and Date

 # Select the latest sampling occasion based on mark
MN.Masterfile.sort3 <- MN.Masterfile.sort2[which(MN.Masterfile.sort2$Latest=='1'), ]
MN.Masterfile.sort3$Latest <- NULL # Remove "Latest" column
MN.Masterfile.sort3 <- MN.Masterfile.sort3[!duplicated(MN.Masterfile.sort3[c('SiteID', 'CommonName')]),]
MN.Master.fish.latest <- MN.Masterfile.sort3 # Change name



 ## Final data ##

str(MN.Master.fish.latest)
```


# 2. WI Data Management

## (1) Data Property
The file 'WI_station_info_originalfile.csv' has unique site number and GPS coordinates. The file 'WI_Fish_dataset_originalfile.csv' has Site ID, sampling date, fish abundance or information of each collected individuals. Thus, additional treatments, such as calculating abundance of each species in each sampling site, is required.
Data property:
(1) WI_station_info_originalfile.csv: WBIC (site ID), MONIT_STATION_SEQ_NO (unique sampling ID), GPS coordinates
(2) WI_Fish_dataset_originalfile.csv: WBIC (site ID), MONIT_STATION_SEQ_NO (unique sampling ID), date, collected fish (by individuals)
Similar to MN data, there are mismatch between site and fish data, thus a couple of filtering process is required.
```{r WI read data}
# Station data
WI.Station <- read.csv("WI_station_info_originalfile.csv", header=TRUE, strip.white=TRUE)

# "MONIT_STATION_SEQ_NO" in WI.Station is matched with "SiteSeqNo" in WI.FishData. Therefore, let's change the column name "MONIT_STATION_SEQ_NO" to "SiteSeqNo."
colnames(WI.Station)[which(names(WI.Station) == "MONIT_STATION_SEQ_NO")] <- "SiteSeqNo"

# Fish data
WI.FishData <- read.csv("WI_Fish_dataset_originalfile.csv", header=TRUE, strip.white=TRUE)
WI.FishData$Species <- gsub(" ", "_", WI.FishData$Species) # replace space to underscore (underbar)
WI.FishData$Species <- toupper(WI.FishData$Species) # change common name format
```

## (2) Fish data treatment
This is to remove all unidentified species and hybrids that appeared in data. 
```{r WI Fish data treatment}
# Remove unidentified species and hybrid
WI.FishData <-WI.FishData[!(WI.FishData$Species %in% c("AMEIURUS_SPP.","CAMPOSTOMA_SPP.","CARPIODES_SPP.","CATOSTOMIDAE_-_UNIDENTIFIED","COMMON_SHINER_X_CREEK_CHUB","COMMON_SHINER_X_EMERALD_SHINER","COMMON_SHINER_X_HORNYHEAD
","COMMON_SHINER_X_HORNYHEAD","COMMON_SHINER_X_SOUTHERN_REDBELLY_DACE","COMMON_SHINER_X_STONEROLLER","COMMON_SHINER_X_UNKNOWN","COTTUS_SPP.","CREEK_CHUB_X_HORNYHEAD_CHUB","CREEK_CHUB_X_UNKNOWN","CYPRINELLA_SPP.","CYPRINIDAE_-_UNIDENTIFIED","FAM:_LAMPREY","FAM:_MINNOWS","GEN:_BUFFALOS","GEN:_CARPSUCKERS","GEN:_CATOSTOMUS","GEN:_COMMON_SUNFISHES","GEN:_ETHEOSTOMA","GEN:_NOTROPIS","GEN:_PERCINA","GEN:_PHOXINUS","GEN:_REDHORSES","GEN:_STONEROLLERS","GREEN_SUNFISH_X_BLUEGILL","GREEN_SUNFISH_X_BLUEGILL_X_PUMPKINSEED","GREEN_SUNFISH_X_ORANGESPOTTED_SUNFISH","GREEN_SUNFISH_X_PUMPKINSEED","HIODON_SPP.","HYBOGNATHUS_SPP.","HYBRID:_COMMON_SHINER_X_SO._REDBELLY_DACE","HYBRID:_GREEN_SUNF._X_BLUEGILL","HYBRID_MINNOW","HYBRID_PHOXINUS","HYBRID_SUNFISH","ICTIOBUS_SPP.","LAMPREY_AMMOCOETE","LAMPREYS_(AMMOCOETE)","LAMPREYS","LEPISOSTEUS_SPP.","MOXOSTOMA_SPP.","NO_FISH_CAPTURED","NOTROPIS_SPP.","PERCINA_SPP.","POMOXIS_SPP.","PUMPKINSEED_X_BLUEGILL","PUMPKINSEED_X_WARMOUTH","ROSYFACE/CARMINE_SHINER","RUSTY_CRAYFISH","STICKLEBACKS_UNSP.","SUBFAM:_BUFFALO/CARPSUCKERS","TIGER_TROUT","TIGER_TROUT_(I21_X_I22)", "STONEROLLERS","PEARL_DACE", "QUILLBACK_CARPSUCKER", "GOLDFISH")),]

# Change name
WI.FishData[WI.FishData=="AMERICAN_BROOK_LAMPREY_(AMMOCOETE)"]<- "AMERICAN_BROOK_LAMPREY"
WI.FishData[WI.FishData=="CHESNUT_LAMPREY_(AMMOCOETE)"]<- "CHESTNUT_LAMPREY"
WI.FishData[WI.FishData=="NORTHERN_BROOK_LAMPREY_(AMMOCOETE)"]<- "NORTHERN_BROOK_LAMPREY"
WI.FishData[WI.FishData=="SILVER_LAMPREY_(AMMOCOETE)"]<- "SILVER_LAMPREY"
WI.FishData[WI.FishData=="SOUTHERN_BROOK_LAMPREY_(AMMOCOETE)"]<- "SOUTHERN_BROOK_LAMPREY"
WI.FishData[WI.FishData=="NORTHERN_HOG_SUCKER"]<- "NORTHERN_HOGSUCKER"
WI.FishData[WI.FishData=="TROUT-PERCH"]<- "TROUT_PERCH"
WI.FishData[WI.FishData=="TROUTPERCH"]<- "TROUT_PERCH"
```

## (3) Manage and prepare masterfile
```{r class.source="bg-success", class.output="bg-warning"}

##  WI Data management

## (1) Extract fish sampling station number - unique sampling (SiteSeqNo) and station number (WBIC)
WI.Fish.site <- WI.FishData %>%
                select(SiteSeqNo, WBIC) 

 # Unique number of site based on WBIC
WI.Fish.site01 <- WI.Fish.site[!duplicated(WI.Fish.site[c('WBIC')]),]
str(WI.Fish.site01) # n=2830

 # Unique number of site based on SiteSeqNo
WI.Fish.site02 <- WI.Fish.site[!duplicated(WI.Fish.site[c('SiteSeqNo')]),]
WI.Fish.site02$FishSample <- '1' # Add one column to show fish sampling
WI.Fish.site02$WBIC <- NULL # Remove WBIC to avoid duplicate 
str(WI.Fish.site02)



## (2) Extract fish sampling site from "WI.Visit" file

 # Attach 'Fish.site02' (confirmed sampling sites) to 'WI.Visit (station info)' 
WI.Visit02 <- left_join(WI.Fish.site02, WI.Station, by = "SiteSeqNo")
WI.Visit02$FishSample[is.na(WI.Visit02$FishSample)] <- 0 # fill NA to 0 
WI.Visit03 <- WI.Visit02[which(WI.Visit02$FishSample=='1'), ]  # Remove stations without fish sampling
str(WI.Visit03)

 # Remove fish sampling sites which have no GPS coordinates
WI.Visit03$CALC_LL_LAT_DD_AMT[is.na(WI.Visit03$CALC_LL_LAT_DD_AMT)] <- 0 # fill NA to 0 (to remove site without GPS)
WI.Visit04 <- WI.Visit03[!(WI.Visit03$CALC_LL_LAT_DD_AMT %in% c("0")),] 
WI.Visit04$State <- 'WI' # add state
str(WI.Visit04) # unique sampling number: n=1956

 # Check duplicate 
WI.Site.Duplicate <-aggregate(SiteSeqNo ~ WBIC, data = WI.Visit04, "NROW")
summary(WI.Site.Duplicate) # 370 sites were visited more than one time. Range: 2 - 10, median= 1.



## (3) Prepare Masterfile

 # Extract columns from station data
WI.Visit05 <- WI.Visit04 %>%
              select(State, WBIC, SiteSeqNo, CALC_LL_LAT_DD_AMT, CALC_LL_LONG_DD_AMT) %>% # select column
              rename(SiteID =WBIC, VisitUniqueID= SiteSeqNo, LAT= CALC_LL_LAT_DD_AMT, LON= CALC_LL_LONG_DD_AMT) # change column name

 # Extract column from fish data
WI.FishData02 <- WI.FishData %>%
              select(SiteSeqNo, SampleDate, Species, NumberofFish) %>% # select column
              rename(VisitUniqueID= SiteSeqNo, Date= SampleDate, CommonName= Species, Abundance= NumberofFish) # change column name

 # Calculate abundance of each species in each station
WI.FishData021 <-aggregate(Abundance ~ VisitUniqueID + CommonName, data = WI.FishData02, "sum") # calculate fish abundance based on VisitUniqueID

 # Extract unique visit number and date 
WI.FishData_uniqueID <- WI.FishData02[!duplicated(WI.FishData02[c('VisitUniqueID')]),] # remove duplicate based on VisitUniqueID
WI.FishData_uniqueID <- WI.FishData_uniqueID %>% 
                        select(VisitUniqueID, Date) # only select VisitUniqueID and Date

 # Attach fish abundance and unique visit number and date
WI.FishData022 <- left_join(WI.FishData_uniqueID, WI.FishData021, by = "VisitUniqueID") # Attached fish data
str(WI.FishData022)

 # Attach fish abundance data to station data
WI.Masterfile01 <- left_join(WI.FishData022, WI.Visit05, by = "VisitUniqueID") # attach station data (e.g., GPS)
str(WI.Masterfile01)

 # Remove stations which have no GPS coordinates
WI.Masterfile01$LAT[is.na(WI.Masterfile01$LAT)] <- 0 # fill NA to 0 
WI.Masterfile02 <-WI.Masterfile01[!(WI.Masterfile01$LAT %in% c("0")),]

 # Check duplicate
WI.Masterfile02.check1 <- WI.Masterfile02[!duplicated(WI.Masterfile02[c('SiteID')]),] 
str(WI.Masterfile02.check1) # n=1361 correct (unique number of stations)
WI.Masterfile02.check2 <- WI.Masterfile02[!duplicated(WI.Masterfile02[c('VisitUniqueID')]),] 
str(WI.Masterfile02.check2) # n= 1956 correct (unique number of sampling occasions)

 # Change column order
WI.Masterfile02 <-WI.Masterfile02[c("State", "SiteID", "VisitUniqueID", "Date", "LAT", "LON", "CommonName", "Abundance")]
WI.Masterfile.fishdata <- WI.Masterfile02 # rename
WI.Masterfile.fishdata$SiteID <-as.character(WI.Masterfile.fishdata$SiteID) # make as character
WI.Masterfile.fishdata$VisitUniqueID <-as.character(WI.Masterfile.fishdata$VisitUniqueID) # make as character
WI.Masterfile.fishdata$CommonName <-as.character(WI.Masterfile.fishdata$CommonName)
WI.Masterfile.fishdata$Abundance <-as.numeric(WI.Masterfile.fishdata$Abundance) # make as numeric value


## (4) Masterfile including all unique visit number (combination of stations and date) ##

str(WI.Masterfile.fishdata)



## (5) Only select latest sampling occasion in each site ###

 # split Date into month, day, year
WI.Masterfile.fishdata$Date <- as.Date(WI.Masterfile.fishdata$Date, "%m/%d/%Y")

 # Filter SiteID with latest date
WI.Masterfile.sort <- aggregate(Date ~ SiteID, data= WI.Masterfile.fishdata, "max") # select latest sampling occasion based on sampling date
WI.Masterfile.sort$Latest <-'1' # Add Column to mark this site

 # Merge two data frames based on SiteID and Date
WI.Masterfile.sort2 <- left_join(WI.Masterfile.sort, WI.Masterfile.fishdata, by = c("SiteID", "Date"))

 # Select the latest sampling occasion
WI.Masterfile.sort3 <- WI.Masterfile.sort2[which(WI.Masterfile.sort2$Latest=='1'), ]
WI.Masterfile.sort3$Latest <- NULL # Remove "Latest" column
WI.Masterfile.fishdata.latest <- WI.Masterfile.sort3 # Change name


 ## IMPORTANT!! Combine multiple sites in a single siteID - this only happens in WI data
WI.Masterfile.sort4 <- aggregate(Abundance ~ SiteID + CommonName, data= WI.Masterfile.fishdata.latest, "sum") # combine fish abundance
WI.Masterfile.fishdata.lates2 <- WI.Masterfile.fishdata.latest[!duplicated(WI.Masterfile.fishdata.latest[c('Date', 'SiteID')]),] # remove duplicate based on Date and siteID

 # Remove columns
WI.Masterfile.fishdata.lates2$CommonName <- NULL
WI.Masterfile.fishdata.lates2$Abundance <- NULL

 # Attach files
WI.Masterfile.fishdata.lates3 <- left_join(WI.Masterfile.sort4, WI.Masterfile.fishdata.lates2, by = c("SiteID"))

 # re-order column
WI.Master.fishdata.lates3 <-WI.Masterfile.fishdata.lates3[c("State", "SiteID", "VisitUniqueID", "Date", "LAT", "LON", "CommonName", "Abundance")]


 ## Final data ##
WI.Master.fish.latest <- WI.Master.fishdata.lates3
str(WI.Master.fish.latest)

```



# 3. IA Data Management

## (1) Data Property
The file 'IA_DNR_Fish_collections_originalfile.csv' has sampling data, species name and abuduance. The file 'IA_DNR_site_info_originalfile.csv' has Site ID, sampling date, and GPS coordinates. Datesets are well-organized compare with other two states.
Data property:
(1) IA_DNR_site_info_originalfile.csv: SiteID (site ID), SessionID (unique sampling ID), GPS coodinates
(2) IA_DNR_Fish_collections_originalfile.csv: SiteID (site ID), SessionID (unique sampling ID), date, fish list (with abundance)
```{r IA read data}
# Station data
IA.Station <- read.csv("IA_DNR_site_info_originalfile.csv", header=TRUE, strip.white=TRUE)
IA.Station$State <- 'IA' # add state

# Fish data
IA.FishData <- read.csv("IA_DNR_Fish_collections_originalfile.csv", header=TRUE, strip.white=TRUE)
IA.FishData$Species <- gsub(" ", "_", IA.FishData$Species) # replace space to underscore (underbar)
IA.FishData$Species <- toupper(IA.FishData$Species) # change common name format
```

## (2) Fish data treatment
```{r IA Fish data treatment}
# Remove unidentified species and hybrid
IA.FishData <-IA.FishData[!(IA.FishData$Species %in% c("AMEIURUS_SPP.","CAMPOSTOMA_SPP.","CARPIODES_SPP.","CATOSTOMIDAE_-_UNIDENTIFIED","COMMON_SHINER_X_CREEK_CHUB","COMMON_SHINER_X_EMERALD_SHINER","COMMON_SHINER_X_HORNYHEAD
","COMMON_SHINER_X_HORNYHEAD","COMMON_SHINER_X_SOUTHERN_REDBELLY_DACE","COMMON_SHINER_X_STONEROLLER","COMMON_SHINER_X_UNKNOWN","COTTUS_SPP.","CREEK_CHUB_X_HORNYHEAD_CHUB","CREEK_CHUB_X_UNKNOWN","CYPRINELLA_SPP.","CYPRINIDAE_-_UNIDENTIFIED","FAM:_LAMPREY","FAM:_MINNOWS","GEN:_BUFFALOS","GEN:_CARPSUCKERS","GEN:_CATOSTOMUS","GEN:_COMMON_SUNFISHES","GEN:_ETHEOSTOMA","GEN:_NOTROPIS","GEN:_PERCINA","GEN:_PHOXINUS","GEN:_REDHORSES","GEN:_STONEROLLERS","GREEN_SUNFISH_X_BLUEGILL","GREEN_SUNFISH_X_BLUEGILL_X_PUMPKINSEED","GREEN_SUNFISH_X_ORANGESPOTTED_SUNFISH","GREEN_SUNFISH_X_PUMPKINSEED","HIODON_SPP.","HYBOGNATHUS_SPP.","HYBRID:_COMMON_SHINER_X_SO._REDBELLY_DACE","HYBRID:_GREEN_SUNF._X_BLUEGILL","HYBRID_MINNOW","HYBRID_PHOXINUS","HYBRID_SUNFISH","ICTIOBUS_SPP.","LAMPREY_AMMOCOETE","LAMPREYS_(AMMOCOETE)","LAMPREYS","LEPISOSTEUS_SPP.","MOXOSTOMA_SPP.","NO_FISH_CAPTURED","NOTROPIS_SPP.","PERCINA_SPP.","POMOXIS_SPP.","PUMPKINSEED_X_BLUEGILL","PUMPKINSEED_X_WARMOUTH","ROSYFACE/CARMINE_SHINER","RUSTY_CRAYFISH","STICKLEBACKS_UNSP.","SUBFAM:_BUFFALO/CARPSUCKERS","TIGER_TROUT","TIGER_TROUT_(I21_X_I22)", "STONEROLLERS","PEARL_DACE", "QUILLBACK_CARPSUCKER", "GOLDFISH")),]

# Change name
IA.FishData[IA.FishData=="AMERICAN_BROOK_LAMPREY_(AMMOCOETE)"]<- "AMERICAN_BROOK_LAMPREY"
IA.FishData[IA.FishData=="CHESNUT_LAMPREY_(AMMOCOETE)"]<- "CHESTNUT_LAMPREY"
IA.FishData[IA.FishData=="NORTHERN_BROOK_LAMPREY_(AMMOCOETE)"]<- "NORTHERN_BROOK_LAMPREY"
IA.FishData[IA.FishData=="SILVER_LAMPREY_(AMMOCOETE)"]<- "SILVER_LAMPREY"
IA.FishData[IA.FishData=="SOUTHERN_BROOK_LAMPREY_(AMMOCOETE)"]<- "SOUTHERN_BROOK_LAMPREY"
IA.FishData[IA.FishData=="NORTHERN_HOG_SUCKER"]<- "NORTHERN_HOGSUCKER"
IA.FishData[IA.FishData=="TROUT-PERCH"]<- "TROUT_PERCH"
IA.FishData[IA.FishData=="TROUTPERCH"]<- "TROUT_PERCH"
```

## (3) Manage and prepare masterfile
```{r class.source="bg-success", class.output="bg-warning"}

## IA Data management

## (1) Extract fish sampling site
IA.Fish.site <- IA.FishData %>%
                select(SessionID, SiteID) # select column

 # Unique number of site based on SiteID
IA.Fish.site01 <- IA.Fish.site[!duplicated(IA.Fish.site[c('SiteID')]),]
str(IA.Fish.site01) # n=696

 # Unique number of site based on SessionID
IA.Fish.site02 <- IA.Fish.site[!duplicated(IA.Fish.site[c('SessionID')]),]
IA.Fish.site02$FishSample <- '1' # Add one column to show fish sampling
str(IA.Fish.site02) # n= 1277



## (2) Extract fish sampling site form "IA.Visit" file

 # Attach Fish.site02 to IA.Visit 
IA.Visit02 <- left_join(IA.Fish.site02, IA.Station, by = "SiteID")

 # Remove sites without fish sampling
IA.Visit03 <- IA.Visit02[which(IA.Visit02$FishSample=='1'), ] # n=1277

 # Remove fish sampling sites without GPS
IA.Visit03$LatDD[is.na(IA.Visit03$LatDD)] <- 0 # fill NA to 0 (to remove site IAthout GPS)
IA.Visit04 <- IA.Visit03[!(IA.Visit03$LatDD %in% c("0")),] # n=1277: no missing GPS data

 ## Since there is no missing data/value in site and fish data. Let's attached two datasets directly 

 # Extract core columns from station data
IA.Station01 <- IA.Station %>%
                select(State, SiteID, LatDD, LonDD) %>% # select column
                rename(LAT= LatDD, LON= LonDD) # change column name

 # Extract core columns from fish data
IA.FishData01 <- IA.FishData %>%
                 select(SessionID, SiteID, Species, SampleDate, TotalCount) %>% # select column
                 rename(VisitUniqueID= SessionID, CommonName= Species, Date= SampleDate,Abundance= TotalCount) # change column name



## (3) Prepare Masterfile

 # Attach fishdata to master file
IA.Masterfile01 <- left_join(IA.FishData01, IA.Station01, by = "SiteID")  
str(IA.Masterfile01)

 # Check duplicate
IA.Masterfile02.check1 <- IA.Masterfile01[!duplicated(IA.Masterfile01[c('SiteID')]),] 
str(IA.Masterfile02.check1) # n=696 correct
IA.Masterfile02.check2 <- IA.Masterfile01[!duplicated(IA.Masterfile01[c('VisitUniqueID')]),] 
str(IA.Masterfile02.check2) # n= 1277 correct

 # Several treatments
IA.Masterfile.fishdata <- IA.Masterfile01 # rename
IA.Masterfile.fishdata$SiteID <-as.character(IA.Masterfile.fishdata$SiteID) # make as character
IA.Masterfile.fishdata$CommonName <-as.character(IA.Masterfile.fishdata$CommonName) # make as character
IA.Masterfile.fishdata$VisitUniqueID <-as.character(IA.Masterfile.fishdata$VisitUniqueID) # make as character
IA.Masterfile.fishdata <-IA.Masterfile.fishdata[c("State", "SiteID", "VisitUniqueID", "Date", "LAT", "LON", "CommonName", "Abundance")]
IA.Masterfile.fishdata$Abundance <-as.numeric(IA.Masterfile.fishdata$Abundance) # make as numeric value



## (4) Masterfile including all unique visit number (combination of stations and date) ##

str(IA.Masterfile.fishdata)



## (5) Select the latest sampling occasion in each site ##

 # Split Date into month, day, year
IA.Masterfile.fishdata$Date <- as.Date(IA.Masterfile.fishdata$Date, "%m/%d/%Y")

 # Filter SiteID and select only latest date
IA.Masterfile.sort <- aggregate(Date ~ SiteID, data= IA.Masterfile.fishdata, "max") # select latest sampling occasion based on sampling date
IA.Masterfile.sort$Latest <-'1' # Add Column to mark this site

 # Merge two data frames based on SiteID and Date
IA.Masterfile.sort2 <- left_join(IA.Masterfile.fishdata, IA.Masterfile.sort, by = c("SiteID", "Date"))

 # Select the latest sampling occasion
IA.Masterfile.sort3 <- IA.Masterfile.sort2[which(IA.Masterfile.sort2$Latest=='1'), ]

 # Remove last column and rename
IA.Masterfile.sort3$Latest <- NULL # Remove "Latest" column
IA.Master.fish.latest <- IA.Masterfile.sort3 # renmae

 ## Final data ##

str(IA.Master.fish.latest)

```



# 4. Masterfile
Here are two masterfiles such as (1) all sites including duplicates (site X date) and (2) selected the latest sampling occasion
```{r class.source="bg-success", class.output="bg-warning"}

## Masterfiles ##

## (1) All data including every sampling occasion 
Fish.Masterfile.all <- rbind(MN.Masterfile.fishdata, WI.Masterfile.fishdata, IA.Masterfile.fishdata) # correct
str(Fish.Masterfile.all)
#write.csv(Fish.Masterfile.all, "Fish.Masterfile.all.csv")


## (2) Select the latest sampling data 
Fish.Masterfile.latest <- rbind(MN.Master.fish.latest, WI.Master.fish.latest, IA.Master.fish.latest) # correct
str(Fish.Masterfile.latest)
#write.csv(Fish.Masterfile.latest, "Fish.Masterfile.latest.csv")
```



# 5. Add Wastershed ID into masterfile
In this section, watershed ID resulted from GIS analysis was attached to fish masterfile based on siteID.
The GIS file 'epsg5070_Station_Clip5.dbf' has SiteID, join_arcid (SegmentID), WatershedID(Id).
```{r class.source="bg-success", class.output="bg-warning"}

## (1) Read Shapefile (dbf)
station_polygon <- read.dbf("epsg5070_Station_Clip5.dbf") # read shapefile (dbf file)

 # Select Site ID and Watershed ID
station_polygon1 <- station_polygon %>%
                select(SiteID, join_arcid, Id)  %>% # select column
                rename(WatershedID= Id, SegmentID= join_arcid) # change column name
station_polygon1$WatershedID <- paste("ws", station_polygon1$WatershedID, sep="") # add "ws" character in watershedID
station_polygon1$Sampled <-'1' # Marked target polygons


## (2) Attach fish masterfile to watershed ID
Masterfile.LatestFishdata2 <- left_join(Fish.Masterfile.latest, station_polygon1, by = c("SiteID")) # attach Watershed ID to fish masterfile
Masterfile.LatestFishdata2 <- Masterfile.LatestFishdata2[which(Masterfile.LatestFishdata2$Sampled=='1'), ] # select wathershedID which has sampling sites
Masterfile.LatestFishdata2$Sampled <- NULL

 # (2-1) How many unique number of sites in each Watershed ID?
Watershed_site <- aggregate(SiteID ~ WatershedID, data= Masterfile.LatestFishdata2, FUN=function(x) length(unique(x)))
str(Watershed_site)

 # (2-2) How many unique number of species in each Watershed ID?
Watershed_spp <- aggregate(CommonName ~ WatershedID, data= Masterfile.LatestFishdata2, FUN=function(x) length(unique(x)))
str(Watershed_spp)



## (3) Filter watershed based on the number of sites in watershed (threshold: 9 <)
 # Remove watershed which have less than 10 sites
Watershed_site2 <-Watershed_site %>% filter(SiteID > 9)
names(Watershed_site2) <- c("WatershedID", "SiteNum")
str(Watershed_site2) # 93 watersheds are selected (correct)

 # Attach this selected watershed to fish data
Masterfile.LatestFishdata3 <-left_join(Masterfile.LatestFishdata2, Watershed_site2, by = c("WatershedID"))

 # Remove sites which are not included in selected watershed
Masterfile.LatestFishdata3[is.na(Masterfile.LatestFishdata3)] <- 0 # fill NA to 0
Masterfile.LatestFishdata3  <- Masterfile.LatestFishdata3[!(Masterfile.LatestFishdata3$SiteNum %in% c("0")),] # remove "0" thus we only select stations which have watershedID

 # Re-order column
Fish.Masterfile.latest2 <-Masterfile.LatestFishdata3[c("State", "WatershedID","SiteNum","SegmentID", "SiteID", "VisitUniqueID", "Date", "LAT", "LON", "CommonName", "Abundance")]

## Final data ## - This data only includes sites located at 93 selected watershed.
str(Fish.Masterfile.latest2)
##write.csv(Fish.Masterfile.latest2, "Fish.Masterfile.latest2.csv")
```
